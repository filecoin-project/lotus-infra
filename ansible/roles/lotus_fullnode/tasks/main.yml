- name: check for required vars
  fail: msg="Variable '{{ item }}' is not defined"
  when: vars[item] == undefined
  with_items: "{{ required_vars }}"

- name: Update repos and install deps
  apt:
    pkg:
      - mesa-opencl-icd
      - ocl-icd-opencl-dev
      - ntp
    update_cache: yes

- name: lotus start ntp
  systemd:
    name: "ntp"
    enabled: yes
    state: started

- name: lotus daemon user
  user:
    name: "{{ lotus_user }}"
    state: present
    system: yes

- name: remove current lotus repository
  block:
    - name: stop
      systemd:
        name: lotus-daemon
        state: stopped
    - name: remove repo
      file:
        path: "{{ lotus_path }}"
        state: absent
  when: lotus_reset == "yes"

- name: lotus path directory
  file:
    path: "{{ lotus_path }}"
    state: directory
    owner: "{{ lotus_user }}"
    group: "{{ lotus_user }}"
    mode: "0700"

- name: lotus ensure LOTUS_PATH env
  lineinfile:
    path: /etc/environment
    line: LOTUS_PATH="{{ lotus_path }}"

- name: proof params directory
  file:
    path: "{{ lotus_proof_params_path }}"
    state: directory
    owner: "{{ lotus_user }}"
    group: "{{ lotus_user }}"
    mode: "0700"


- name: lotus golog file
  file:
    state: touch
    path: "{{ lotus_golog_file }}"
    owner: "{{ lotus_user }}"
    group: "{{ lotus_user }}"
    mode: "0644"

- name: lotus systemd service file
  template:
    src: ../templates/lotus-daemon.service.j2
    dest: /etc/systemd/system/lotus-daemon.service
    owner: root
    group: root
    mode: "0644"
  notify:
    - reload-lotus

- name: lotus binary
  copy:
    src: "{{ lotus_binary_src }}"
    dest: /usr/local/bin/lotus
    owner: root
    group: root
    mode: "0755"
  notify:
    - restart-lotus

- name: lotus config
  template:
    src: ../templates/config.toml.j2
    dest: "{{ lotus_path }}/config.toml"
    owner: "{{ lotus_user }}"
    group: "{{ lotus_user }}"
    mode: "0644"
  notify:
    - restart-lotus

- name: lotus service started
  systemd:
    name: "lotus-daemon"
    state: started

- name: get default wallet
  shell: /usr/local/bin/lotus wallet default
  environment:
    LOTUS_PATH: "{{ lotus_path }}"
  ignore_errors: yes
  register: r_default_wallet

- debug:
    msg: lotus wallet default {{ r_default_wallet.stdout }}

- name: import wallet
  block:
    - name: wait for daemon online
      shell: sleep 10
    - name: import wallet
      shell: /usr/local/bin/lotus wallet import
      args:
        stdin: "{{ lotus_wallet_keyinfo }}"
      environment:
        LOTUS_PATH: "{{ lotus_path }}"
    - name: set default
      shell: /usr/local/bin/lotus wallet set-default "{{ lotus_wallet_address }}"
      environment:
        LOTUS_PATH: "{{ lotus_path }}"
  when: lotus_wallet_keyinfo is defined and r_default_wallet.stdout != lotus_wallet_address

- name: lotus service started
  systemd:
    name: "lotus-daemon"
    enabled: yes
    state: started
