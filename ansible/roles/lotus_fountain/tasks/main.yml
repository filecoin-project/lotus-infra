- name: lotus golog file
  file:
      state: touch
      path: "{{ lotus_fountain_golog_file }}"
      owner: "{{ lotus_user }}"
      group: "{{ lotus_user }}"
      mode: "0644"

- name: lotus systemd service file
  template:
      src: ../templates/lotus-fountain.service.j2
      dest: /etc/systemd/system/lotus-fountain.service
      owner: root
      group: root
      mode: "0644"
  notify:
      - reload-fountain

- name: lotus binary
  copy:
      src: "{{ lotus_fountain_binary_src }}"
      dest: /usr/local/bin/lotus-fountain
      owner: root
      group: root
      mode: "0755"
  when: lotus_fountain_copy_binary
  notify:
      - restart-fountain

- name: lotus service started
  systemd:
    name: "lotus-fountain"
    enabled: yes
    state: started

- name: copy nginx config
  template:
    src: ../templates/nginx.conf.j2
    dest: /etc/nginx/conf.d/lotus-fountain.conf
    mode: 0644
  notify:
    - restart nginx

- name: create let's encrypt webroot
  file:
    path: /var/www/{{ lotus_fountain_server_name }}/.well-known
    state: directory

- name: create let's encrypt certificate
  command: "certbot certonly --webroot -w /var/www/{{ lotus_fountain_server_name }} -d {{ lotus_fountain_server_name }} --non-interactive --agree-tos -m infra-accounts@protocol.ai"
  run_once: true
  when: certbot_create_certificate

- name: copy nginx https config
  template:
    src: ../templates/nginx-https.conf.j2
    dest: /etc/nginx/conf.d/lotus-fountain-https.conf
    mode: 0644
  notify:
    - restart nginx

- set_fact:
    lotus_fountain_ufw_profile:
      name: Lotus Fountain
      value: "{{ lookup('template', '../templates/ufw.profile.j2')}}"
